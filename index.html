<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Chronicle</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=JetBrains+Mono:wght@300;400&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --ink: #0a0806;
  --ink2: #13100c;
  --panel: #1a1510;
  --panel2: #221c14;
  --paper: #f0e8d8;
  --muted: #7a7060;
  --gold: #c9a84c;
  --gold2: #e8c56a;
  --gold-dim: #7a6028;
  --rust: #8b3a2a;
  --border: rgba(201,168,76,0.18);
  --border2: rgba(255,255,255,0.06);
  --glow: rgba(201,168,76,0.06);
  --safe-top: env(safe-area-inset-top);
  --safe-bottom: env(safe-area-inset-bottom);
}

- { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

html, body {
height: 100%;
background: var(â€“ink);
color: var(â€“paper);
font-family: â€˜Outfitâ€™, sans-serif;
font-weight: 300;
overflow-x: hidden;
}

/* â”€â”€ BACKGROUND â”€â”€ */
body::before {
content: â€˜â€™;
position: fixed; inset: 0; z-index: 0;
background:
radial-gradient(ellipse 60% 40% at 15% 60%, rgba(201,168,76,0.04) 0%, transparent 70%),
radial-gradient(ellipse 50% 60% at 85% 20%, rgba(139,58,42,0.05) 0%, transparent 60%);
pointer-events: none;
}

/* â”€â”€ HEADER â”€â”€ */
header {
position: fixed; top: 0; left: 0; right: 0; z-index: 100;
padding: calc(var(â€“safe-top) + 14px) 20px 14px;
background: rgba(10,8,6,0.85);
backdrop-filter: blur(20px);
-webkit-backdrop-filter: blur(20px);
border-bottom: 1px solid var(â€“border);
display: flex; align-items: center; justify-content: space-between;
}

.logo {
font-family: â€˜Cormorant Garamondâ€™, serif;
font-size: 22px; font-weight: 600;
color: var(â€“gold); letter-spacing: 0.1em;
}
.logo-sub {
font-size: 9px; font-family: â€˜JetBrains Monoâ€™, monospace;
letter-spacing: 0.25em; text-transform: uppercase;
color: var(â€“muted); display: block; margin-top: -2px;
}

.key-dots { display: flex; gap: 6px; align-items: center; }
.key-dot {
width: 8px; height: 8px; border-radius: 50%;
background: rgba(139,58,42,0.6);
transition: background 0.3s;
position: relative;
}
.key-dot.ok { background: rgba(80,180,80,0.7); }
.key-dot::after {
content: attr(data-label);
position: absolute; top: 14px; right: 0;
font-family: â€˜JetBrains Monoâ€™, monospace;
font-size: 8px; white-space: nowrap;
color: var(â€“muted); letter-spacing: 0.1em;
}

/* â”€â”€ BOTTOM NAV â”€â”€ */
.bottom-nav {
position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
padding: 10px 0 calc(var(â€“safe-bottom) + 10px);
background: rgba(10,8,6,0.92);
backdrop-filter: blur(20px);
-webkit-backdrop-filter: blur(20px);
border-top: 1px solid var(â€“border);
display: flex;
}

.nav-btn {
flex: 1; background: none; border: none;
display: flex; flex-direction: column; align-items: center; gap: 4px;
color: var(â€“muted); font-family: â€˜Outfitâ€™, sans-serif;
font-size: 10px; letter-spacing: 0.05em; cursor: pointer;
padding: 4px 0; transition: color 0.2s;
}
.nav-btn .nav-icon { font-size: 20px; line-height: 1; }
.nav-btn.active { color: var(â€“gold); }

/* â”€â”€ MAIN SCROLL AREA â”€â”€ */
main {
position: relative; z-index: 1;
padding-top: calc(var(â€“safe-top) + 70px);
padding-bottom: calc(var(â€“safe-bottom) + 80px);
min-height: 100vh;
}

.tab { display: none; }
.tab.active { display: block; animation: fadeUp 0.3s ease; }

@keyframes fadeUp {
from { opacity: 0; transform: translateY(12px); }
to   { opacity: 1; transform: translateY(0); }
}

/* â”€â”€ STORY TAB â”€â”€ */
.story-top {
padding: 20px 20px 0;
display: flex; flex-direction: column; gap: 12px;
}

/* Genre pills */
.genre-scroll {
display: flex; gap: 8px;
overflow-x: auto; padding-bottom: 4px;
scrollbar-width: none;
}
.genre-scroll::-webkit-scrollbar { display: none; }

.genre-pill {
flex-shrink: 0;
background: rgba(255,255,255,0.03);
border: 1px solid var(â€“border2);
border-radius: 20px;
color: var(â€“muted);
font-size: 12px; padding: 6px 14px;
cursor: pointer; transition: all 0.2s;
white-space: nowrap;
font-family: â€˜Outfitâ€™, sans-serif;
}
.genre-pill.active {
background: var(â€“gold);
border-color: var(â€“gold);
color: var(â€“ink);
font-weight: 500;
}

/* Story start panel */
.story-start-wrap {
border: 1px solid var(â€“border2);
border-radius: 12px;
overflow: hidden;
}

.story-start-toggle {
width: 100%; background: var(â€“panel);
border: none; cursor: pointer;
display: flex; align-items: center; justify-content: space-between;
padding: 11px 14px; transition: background 0.2s;
}
.story-start-toggle:hover { background: var(â€“panel2); }

.start-toggle-label {
font-family: â€˜JetBrains Monoâ€™, monospace;
font-size: 10px; letter-spacing: 0.15em; text-transform: uppercase;
color: var(â€“gold);
}

.start-toggle-arrow {
color: var(â€“muted); font-size: 18px;
transition: transform 0.25s; display: inline-block;
}
.start-toggle-arrow.open { transform: rotate(90deg); }

.story-start-panel {
background: var(â€“panel2);
border-top: 1px solid var(â€“border2);
padding: 12px;
display: flex; flex-direction: column; gap: 8px;
}
.story-start-panel.hidden { display: none; }

.story-start-input {
width: 100%; background: rgba(255,255,255,0.03);
border: 1px solid var(â€“border2); border-radius: 10px;
color: var(â€“paper); font-family: â€˜Outfitâ€™, sans-serif;
font-size: 13px; line-height: 1.55; padding: 11px 13px;
resize: vertical; outline: none; transition: border-color 0.2s;
}
.story-start-input::placeholder { color: var(â€“muted); opacity: 0.45; }
.story-start-input:focus { border-color: var(â€“gold-dim); }

.start-hint {
font-size: 11px; color: var(â€“muted); opacity: 0.6;
font-family: â€˜JetBrains Monoâ€™, monospace; letter-spacing: 0.05em;
}

/* Input row */
.input-row {
display: flex; gap: 8px; align-items: flex-end;
}

.story-textarea {
flex: 1;
background: var(â€“panel);
border: 1px solid var(â€“border2);
border-radius: 12px;
color: var(â€“paper);
font-family: â€˜Outfitâ€™, sans-serif;
font-size: 14px; line-height: 1.5;
padding: 12px 14px;
resize: none; outline: none;
min-height: 48px; max-height: 120px;
overflow-y: auto;
transition: border-color 0.2s;
}
.story-textarea::placeholder { color: var(â€“muted); opacity: 0.6; }
.story-textarea:focus { border-color: var(â€“gold-dim); }

.send-btn {
width: 48px; height: 48px; flex-shrink: 0;
background: var(â€“gold);
border: none; border-radius: 12px;
cursor: pointer; display: flex; align-items: center; justify-content: center;
font-size: 20px; transition: all 0.2s;
}
.send-btn:hover { background: var(â€“gold2); }
.send-btn:disabled { opacity: 0.4; cursor: not-allowed; }
.send-btn.loading { background: var(â€“gold-dim); }

/* Story feed */
.story-feed {
padding: 16px 20px;
display: flex; flex-direction: column; gap: 20px;
}

.story-empty {
text-align: center; padding: 60px 20px;
color: var(â€“muted);
}
.story-empty .empty-icon { font-size: 52px; margin-bottom: 16px; opacity: 0.3; }
.story-empty p { font-size: 14px; line-height: 1.7; }

.story-card {
background: var(â€“panel);
border: 1px solid var(â€“border);
border-radius: 16px;
overflow: hidden;
animation: fadeUp 0.4s ease;
}

.story-card-text {
padding: 24px 22px;
}

.story-card-meta {
display: flex; align-items: center; gap: 10px; margin-bottom: 16px;
}
.genre-tag {
font-family: â€˜JetBrains Monoâ€™, monospace;
font-size: 9px; letter-spacing: 0.2em; text-transform: uppercase;
color: var(â€“gold); border: 1px solid var(â€“border);
padding: 3px 9px; border-radius: 20px;
}
.meta-line { flex: 1; height: 1px; background: var(â€“border); }

.story-prose {
font-family: â€˜Cormorant Garamondâ€™, serif;
font-size: 18px; line-height: 1.85;
color: #e5dcc8; font-weight: 300;
}
.story-prose p + p { margin-top: 14px; }

.story-card-image {
background: var(â€“ink2);
min-height: 200px;
position: relative;
overflow: hidden;
}
.story-card-image img {
width: 100%; display: block;
max-height: 500px; object-fit: cover;
}
.img-loading {
display: flex; flex-direction: column; align-items: center;
justify-content: center; height: 220px; gap: 14px;
color: var(â€“muted); font-size: 13px;
}
.spinner-ring {
width: 36px; height: 36px;
border: 2px solid rgba(201,168,76,0.15);
border-top-color: var(â€“gold);
border-radius: 50%;
animation: spin 0.9s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.img-error {
display: flex; flex-direction: column; align-items: center;
justify-content: center; height: 160px; gap: 8px;
color: var(â€“muted); font-size: 12px; text-align: center;
padding: 20px;
}

.new-char-banner {
background: rgba(201,168,76,0.08);
border-top: 1px solid var(â€“border);
padding: 12px 22px;
font-size: 12px; color: var(â€“gold);
font-family: â€˜JetBrains Monoâ€™, monospace;
letter-spacing: 0.05em;
}

/* â”€â”€ CHARACTERS TAB â”€â”€ */
.tab-header {
padding: 20px 20px 0;
display: flex; align-items: center; justify-content: space-between;
margin-bottom: 16px;
}
.tab-title {
font-family: â€˜Cormorant Garamondâ€™, serif;
font-size: 26px; font-weight: 600;
}
.add-btn {
background: none; border: 1px solid var(â€“border);
border-radius: 8px; color: var(â€“gold);
font-family: â€˜Outfitâ€™, sans-serif; font-size: 13px;
padding: 8px 14px; cursor: pointer; transition: all 0.2s;
}
.add-btn:hover { background: var(â€“glow); }

.chars-list {
padding: 0 20px;
display: flex; flex-direction: column; gap: 14px;
}

.char-card {
background: var(â€“panel);
border: 1px solid var(â€“border);
border-radius: 14px; overflow: hidden;
}
.char-card.protagonist { border-color: rgba(201,168,76,0.4); }

.char-top {
display: flex; gap: 14px; padding: 16px;
align-items: flex-start;
}

.char-img-wrap {
width: 72px; height: 72px; flex-shrink: 0;
border-radius: 10px; overflow: hidden;
background: var(â€“panel2);
position: relative; cursor: pointer;
}
.char-img-wrap img { width: 100%; height: 100%; object-fit: cover; }
.char-img-placeholder {
width: 100%; height: 100%;
display: flex; flex-direction: column; align-items: center;
justify-content: center; gap: 4px;
color: var(â€“muted); font-size: 9px; text-align: center;
letter-spacing: 0.05em;
}
.char-img-placeholder span:first-child { font-size: 24px; opacity: 0.3; }
.char-img-overlay {
position: absolute; inset: 0;
background: rgba(0,0,0,0.55);
display: flex; align-items: center; justify-content: center;
font-size: 18px; opacity: 0; transition: opacity 0.2s;
}
.char-img-wrap:hover .char-img-overlay { opacity: 1; }

.char-info { flex: 1; min-width: 0; }
.char-name-input {
width: 100%; background: none; border: none;
border-bottom: 1px solid var(â€“border2);
color: var(â€“paper);
font-family: â€˜Cormorant Garamondâ€™, serif;
font-size: 20px; font-weight: 600;
padding-bottom: 6px; margin-bottom: 8px; outline: none;
}
.char-name-input:focus { border-bottom-color: var(â€“gold-dim); }

.char-nick-input {
width: 100%; background: none; border: none;
border-bottom: 1px solid var(â€“border2);
color: var(â€“muted); font-family: â€˜Outfitâ€™, sans-serif;
font-size: 12px; font-style: italic;
padding-bottom: 6px; margin-bottom: 8px; outline: none;
transition: border-bottom-color 0.2s;
}
.char-nick-input::placeholder { color: var(â€“muted); opacity: 0.4; }
.char-nick-input:focus { border-bottom-color: var(â€“gold-dim); color: var(â€“paper); }

.char-role-select {
background: rgba(255,255,255,0.03);
border: 1px solid var(â€“border2); border-radius: 6px;
color: var(â€“muted); font-family: â€˜Outfitâ€™, sans-serif;
font-size: 12px; padding: 5px 8px; outline: none; cursor: pointer;
width: 100%;
}
.char-role-select option { background: var(â€“panel); }

.char-desc-wrap { padding: 0 16px 16px; }
.char-desc-input {
width: 100%; background: rgba(255,255,255,0.02);
border: 1px solid var(â€“border2); border-radius: 8px;
color: var(â€“muted); font-family: â€˜Outfitâ€™, sans-serif;
font-size: 13px; line-height: 1.5;
padding: 10px 12px; resize: vertical; min-height: 70px;
outline: none; transition: border-color 0.2s;
}
.char-desc-input::placeholder { color: var(â€“muted); opacity: 0.4; }
.char-desc-input:focus { border-color: var(â€“gold-dim); color: var(â€“paper); }

.char-footer-row {
display: flex; align-items: center; justify-content: space-between;
padding: 10px 16px;
border-top: 1px solid var(â€“border2);
}
.char-source-label {
font-family: â€˜JetBrains Monoâ€™, monospace;
font-size: 9px; color: var(â€“muted); opacity: 0.5; letter-spacing: 0.1em;
}
.char-del-btn {
background: none; border: none;
color: var(â€“rust); font-size: 12px;
cursor: pointer; opacity: 0.5; transition: opacity 0.2s;
font-family: â€˜Outfitâ€™, sans-serif;
}
.char-del-btn:hover { opacity: 1; }

.chars-empty {
text-align: center; padding: 50px 20px;
color: var(â€“muted); font-size: 14px; line-height: 1.7;
}

/* â”€â”€ SETTINGS TAB â”€â”€ */
.settings-body { padding: 20px; display: flex; flex-direction: column; gap: 16px; }

.settings-card {
background: var(â€“panel);
border: 1px solid var(â€“border);
border-radius: 14px; padding: 20px;
}
.settings-card h3 {
font-family: â€˜Cormorant Garamondâ€™, serif;
font-size: 19px; margin-bottom: 4px;
}
.settings-card p {
font-size: 13px; color: var(â€“muted); line-height: 1.6; margin-bottom: 16px;
}
.settings-card a { color: var(â€“gold); text-decoration: none; }

.field-label {
font-family: â€˜JetBrains Monoâ€™, monospace;
font-size: 9px; letter-spacing: 0.2em; text-transform: uppercase;
color: var(â€“gold); margin-bottom: 6px; display: block;
}

.api-row { display: flex; gap: 8px; margin-bottom: 6px; }

.api-field {
flex: 1; background: rgba(255,255,255,0.03);
border: 1px solid var(â€“border2); border-radius: 10px;
color: var(â€“paper); font-family: â€˜JetBrains Monoâ€™, monospace;
font-size: 12px; padding: 11px 13px; outline: none;
transition: border-color 0.2s;
}
.api-field::placeholder { color: var(â€“muted); opacity: 0.4; }
.api-field:focus { border-color: var(â€“gold-dim); }

.save-btn {
background: none; border: 1px solid var(â€“border);
border-radius: 10px; color: var(â€“gold);
font-family: â€˜Outfitâ€™, sans-serif; font-size: 13px;
padding: 11px 16px; cursor: pointer; transition: all 0.2s;
white-space: nowrap;
}
.save-btn:hover { background: var(â€“glow); border-color: var(â€“gold); }

.saved-msg {
font-family: â€˜JetBrains Monoâ€™, monospace; font-size: 10px;
color: #70c070; display: none; margin-bottom: 12px;
}
.saved-msg.show { display: block; }

.model-field {
width: 100%; background: rgba(255,255,255,0.03);
border: 1px solid var(â€“border2); border-radius: 10px;
color: var(â€“paper); font-family: â€˜Outfitâ€™, sans-serif;
font-size: 13px; padding: 11px 13px; outline: none; cursor: pointer;
margin-top: 12px;
}
.model-field option { background: var(â€“panel); }

.danger-btn {
width: 100%; background: none;
border: 1px solid rgba(139,58,42,0.35); border-radius: 10px;
color: var(â€“rust); font-family: â€˜Outfitâ€™, sans-serif;
font-size: 13px; padding: 12px; cursor: pointer; transition: all 0.2s;
margin-top: 4px;
}
.danger-btn:hover { background: rgba(139,58,42,0.1); border-color: var(â€“rust); }

/* â”€â”€ TOAST â”€â”€ */
.toast {
position: fixed; bottom: calc(var(â€“safe-bottom) + 90px); left: 20px; right: 20px;
z-index: 999;
background: var(â€“panel2); border: 1px solid var(â€“border);
border-radius: 12px; padding: 14px 18px;
font-size: 13px; text-align: center;
transform: translateY(20px); opacity: 0;
transition: all 0.3s; pointer-events: none;
}
.toast.show { transform: translateY(0); opacity: 1; }
.toast.err { border-color: rgba(139,58,42,0.5); color: #d08080; }

/* â”€â”€ HIDDEN â”€â”€ */
.hidden { display: none !important; }
</style>

</head>
<body>

<header>
  <div class="logo">
    Chronicle
    <span class="logo-sub">AI Story Generator</span>
  </div>
  <div class="key-dots">
    <div class="key-dot" id="dot-grok" data-label="GROK"></div>
    <div class="key-dot" id="dot-gemini" data-label="GEMINI"></div>
  </div>
</header>

<main>

  <!-- â•â• STORY TAB â•â• -->

  <div class="tab active" id="tab-story">
    <div class="story-top">
      <!-- Genre -->
      <div class="genre-scroll" id="genre-scroll">
        <button class="genre-pill active" data-genre="Fantasy">âš”ï¸ Fantasy</button>
        <button class="genre-pill" data-genre="Sci-Fi">ğŸš€ Sci-Fi</button>
        <button class="genre-pill" data-genre="Horror">ğŸ•¯ï¸ Horror</button>
        <button class="genre-pill" data-genre="Dark Fantasy">ğŸŒ‘ Dark Fantasy</button>
        <button class="genre-pill" data-genre="Romance">ğŸŒ¹ Romance</button>
        <button class="genre-pill" data-genre="Mystery">ğŸ” Mystery</button>
        <button class="genre-pill" data-genre="Adventure">ğŸ—ºï¸ Adventure</button>
        <button class="genre-pill" data-genre="Thriller">âš¡ Thriller</button>
        <button class="genre-pill" data-genre="Historical">ğŸ“œ Historical</button>
        <button class="genre-pill" data-genre="Cyberpunk">ğŸ¤– Cyberpunk</button>
        <button class="genre-pill" data-genre="Custom">âœï¸ Custom</button>
      </div>
      <!-- Custom genre input (shown when Custom selected) -->
      <div id="custom-genre-wrap" style="display:none;">
        <input class="story-textarea" id="custom-genre-input" type="text"
          placeholder="Describe your custom genre or settingâ€¦ e.g. 'Solarpunk ocean world with bio-tech merfolk'"
          style="min-height:unset;height:44px;width:100%;">
      </div>
      <!-- Story Start -->
      <div class="story-start-wrap">
        <button class="story-start-toggle" id="start-toggle" onclick="toggleStoryStart()">
          <span class="start-toggle-label">âœ¦ Story Starting Point</span>
          <span class="start-toggle-arrow" id="start-arrow">â€º</span>
        </button>
        <div class="story-start-panel hidden" id="start-panel">
          <textarea class="story-start-input" id="story-start"
            placeholder="Set the scene for your storyâ€¦ Where does it begin? Who is there? What's the atmosphere?&#10;&#10;e.g. A candlelit tavern on the edge of a cursed forest. Rain hammers the shutters. You are a wandering sell-sword with a dark pastâ€¦"
            rows="4"></textarea>
          <div class="start-hint">This sets the opening context. Leave blank to let Grok decide.</div>
        </div>
      </div>

```
  <!-- Input -->
  <div class="input-row">
    <textarea class="story-textarea" id="story-input"
      placeholder="What happens next? Guide your storyâ€¦"
      rows="1"
      oninput="autoResize(this)"></textarea>
    <button class="send-btn" id="send-btn" onclick="generateStory()">âœ¦</button>
  </div>
</div>

<div class="story-feed" id="story-feed">
  <div class="story-empty" id="story-empty">
    <div class="empty-icon">ğŸ“–</div>
    <p>Choose a genre above and send<br>your first message to begin.</p>
  </div>
</div>
```

  </div>

  <!-- â•â• CHARACTERS TAB â•â• -->

  <div class="tab" id="tab-characters">
    <div class="tab-header">
      <div class="tab-title">Characters</div>
      <button class="add-btn" onclick="addCharacter()">+ Add</button>
    </div>
    <div class="chars-list" id="chars-list"></div>
  </div>

  <!-- â•â• SETTINGS TAB â•â• -->

  <div class="tab" id="tab-settings">
    <div class="settings-body">

```
  <div class="settings-card">
    <h3>ğŸ— Grok API Key</h3>
    <p>Go to <a href="https://console.x.ai" target="_blank">console.x.ai</a> â†’ sign in with X â†’ API Keys â†’ Create Key. You get <strong style="color:var(--gold)">$25 free credits</strong> to start.</p>
    <label class="field-label">API Key</label>
    <div class="api-row">
      <input class="api-field" type="password" id="grok-input" placeholder="xai-...">
      <button class="save-btn" onclick="saveKey('grok')">Save</button>
    </div>
    <div class="saved-msg" id="grok-saved">âœ“ Saved in your browser</div>
    <label class="field-label">Model</label>
    <select class="model-field" id="grok-model">
      <option value="grok-3">grok-3 (best)</option>
      <option value="grok-3-mini">grok-3-mini (faster)</option>
      <option value="grok-2">grok-2</option>
    </select>
  </div>

  <div class="settings-card">
    <h3>âœ¨ Gemini API Key</h3>
    <p>Go to <a href="https://aistudio.google.com" target="_blank">aistudio.google.com</a> â†’ Get API Key â†’ Create API Key. Completely <strong style="color:var(--gold)">free</strong> to start.</p>
    <label class="field-label">API Key</label>
    <div class="api-row">
      <input class="api-field" type="password" id="gemini-input" placeholder="AIza...">
      <button class="save-btn" onclick="saveKey('gemini')">Save</button>
    </div>
    <div class="saved-msg" id="gemini-saved">âœ“ Saved in your browser</div>
    <label class="field-label">Image Model</label>
    <select class="model-field" id="gemini-model">
      <option value="gemini-3-pro-image-preview">gemini-3-pro-image-preview (recommended)</option>
      <option value="gemini-2.0-flash-preview-image-generation">gemini-2.0-flash image gen (fallback)</option>
    </select>
  </div>

  <div class="settings-card">
    <h3>ğŸ”’ Privacy</h3>
    <p>Your API keys are stored only in this browser on this device. They're sent directly to xAI and Google â€” never to any other server.</p>
    <button class="danger-btn" onclick="clearData()">Clear all saved data</button>
  </div>

</div>
```

  </div>

</main>

<!-- Bottom nav -->

<nav class="bottom-nav">
  <button class="nav-btn active" id="nav-story" onclick="switchTab('story')">
    <span class="nav-icon">ğŸ“–</span>Story
  </button>
  <button class="nav-btn" id="nav-characters" onclick="switchTab('characters')">
    <span class="nav-icon">ğŸ‘¤</span>Characters
  </button>
  <button class="nav-btn" id="nav-settings" onclick="switchTab('settings')">
    <span class="nav-icon">âš™ï¸</span>Settings
  </button>
</nav>

<div class="toast" id="toast"></div>
<input type="file" id="char-upload" accept="image/*" style="display:none">

<script>
// â”€â”€ STATE â”€â”€
const S = {
  genre: 'Fantasy',
  characters: [],
  history: [],
};

let uploadTargetId = null;

// â”€â”€ INIT â”€â”€
function init() {
  loadStorage();
  renderCharacters();
  updateDots();

  document.getElementById('genre-scroll').addEventListener('click', e => {
    const pill = e.target.closest('.genre-pill');
    if (!pill) return;
    document.querySelectorAll('.genre-pill').forEach(p => p.classList.remove('active'));
    pill.classList.add('active');
    S.genre = pill.dataset.genre;
    const customWrap = document.getElementById('custom-genre-wrap');
    customWrap.style.display = S.genre === 'Custom' ? 'block' : 'none';
    if (S.genre === 'Custom') document.getElementById('custom-genre-input').focus();
  });

  document.getElementById('char-upload').addEventListener('change', handleCharUpload);
}

// â”€â”€ STORAGE â”€â”€
function loadStorage() {
  try {
    const d = JSON.parse(localStorage.getItem('chron_data') || '{}');
    S.genre = d.genre || 'Fantasy';
    S.characters = d.characters || [];
    S.history = d.history || [];
    const gKey = localStorage.getItem('chron_grok');
    const mKey = localStorage.getItem('chron_gemini');
    if (gKey) document.getElementById('grok-input').value = gKey;
    if (mKey) document.getElementById('gemini-input').value = mKey;
    const gMod = localStorage.getItem('chron_grok_model');
    const mMod = localStorage.getItem('chron_gemini_model');
    if (gMod) document.getElementById('grok-model').value = gMod;
    if (mMod) document.getElementById('gemini-model').value = mMod;

    // Restore genre pill
    document.querySelectorAll('.genre-pill').forEach(p => {
      p.classList.toggle('active', p.dataset.genre === S.genre);
    });
  } catch(e) {}
}

function saveStorage() {
  try {
    localStorage.setItem('chron_data', JSON.stringify({
      genre: S.genre,
      characters: S.characters.map(c => ({ ...c, imageData: c.imageData || null })),
      history: S.history.map(h => ({ ...h })),
    }));
  } catch(e) {}
}

function saveKey(svc) {
  const val = document.getElementById(svc + '-input').value.trim();
  if (!val) { toast('Please enter a key', true); return; }
  localStorage.setItem('chron_' + svc, val);
  if (svc === 'grok') localStorage.setItem('chron_grok_model', document.getElementById('grok-model').value);
  if (svc === 'gemini') localStorage.setItem('chron_gemini_model', document.getElementById('gemini-model').value);
  updateDots();
  const el = document.getElementById(svc + '-saved');
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 3000);
  toast('Key saved!');
}

function clearData() {
  if (!confirm('Clear all keys, characters and story history?')) return;
  localStorage.clear();
  S.characters = []; S.history = []; S.genre = 'Fantasy';
  document.getElementById('grok-input').value = '';
  document.getElementById('gemini-input').value = '';
  renderCharacters();
  document.getElementById('story-feed').innerHTML = '';
  document.getElementById('story-empty').classList.remove('hidden');
  updateDots();
  toast('Cleared!');
}

function updateDots() {
  document.getElementById('dot-grok').classList.toggle('ok', !!localStorage.getItem('chron_grok'));
  document.getElementById('dot-gemini').classList.toggle('ok', !!localStorage.getItem('chron_gemini'));
}

// â”€â”€ TABS â”€â”€
function switchTab(name) {
  ['story','characters','settings'].forEach(t => {
    document.getElementById('tab-' + t).classList.toggle('active', t === name);
    document.getElementById('nav-' + t).classList.toggle('active', t === name);
  });
  if (name === 'characters') renderCharacters();
}

// â”€â”€ STORY GENERATION â”€â”€
async function generateStory() {
  const grokKey = localStorage.getItem('chron_grok');
  const geminiKey = localStorage.getItem('chron_gemini');

  if (!grokKey) { toast('Add your Grok key in Settings âš™ï¸', true); switchTab('settings'); return; }
  if (!geminiKey) { toast('Add your Gemini key in Settings âš™ï¸', true); switchTab('settings'); return; }

  const prompt = document.getElementById('story-input').value.trim();
  const model = localStorage.getItem('chron_grok_model') || 'grok-3';
  const imgModel = localStorage.getItem('chron_gemini_model') || 'gemini-3-pro-image-preview';

  // Resolve genre label â€” if Custom, read the text input
  const activeGenre = S.genre === 'Custom'
    ? (document.getElementById('custom-genre-input').value.trim() || 'Custom')
    : S.genre;

  const btn = document.getElementById('send-btn');
  btn.disabled = true; btn.classList.add('loading'); btn.textContent = 'â€¦';

  // Character context
  const charCtx = S.characters.length
    ? '\n\nCharacters:\n' + S.characters.map(c => {
        const alias = c.nickname ? ` (also known as "${c.nickname}")` : '';
        return `- ${c.name}${alias} (${c.role}): ${c.description || 'no description'}`;
      }).join('\n')
    : '';

  // History context (last 3)
  const histCtx = S.history.length
    ? '\n\nRecent story:\n' + S.history.slice(-3).map(h => h.text).join('\n\n---\n\n')
    : '';

  const systemMsg = `You are a master storyteller writing a ${activeGenre} story. Write vivid, immersive prose of 2-4 paragraphs. Be consistent with characters and previous events. This is an adult story â€” when the narrative calls for it, depict mature themes, violence, sexuality, or dark content explicitly and without censorship. Write it naturally as part of the story. At the very end add a new line: "NEW_CHARS: name1, name2" listing any brand-new named characters you just introduced, or "NEW_CHARS: none".${charCtx}${histCtx}`;

  // Loading card
  const loadCard = addLoadCard();

  try {
    // 1. Grok story
    updateLoadCard(loadCard, 'Writing your storyâ€¦', true);

    const gRes = await fetch('https://api.x.ai/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${grokKey}` },
      body: JSON.stringify({
        model,
        messages: [
          { role: 'system', content: systemMsg },
          { role: 'user', content: prompt || `Begin the ${activeGenre} story` }
        ],
        max_tokens: 900, temperature: 0.92
      })
    });

    if (!gRes.ok) {
      const e = await gRes.json().catch(() => ({}));
      throw new Error('Grok: ' + (e.error?.message || gRes.status));
    }

    const gData = await gRes.json();
    let text = gData.choices[0].message.content;

    // Extract new chars
    let newChars = [];
    const nc = text.match(/NEW_CHARS:\s*(.+)$/m);
    if (nc && nc[1].toLowerCase().trim() !== 'none') {
      newChars = nc[1].split(',').map(s => s.trim()).filter(Boolean);
      text = text.replace(/\nNEW_CHARS:.+$/m, '').trim();
    }

    // Auto-add new characters
    newChars.forEach(name => {
      if (!S.characters.find(c => c.name.toLowerCase() === name.toLowerCase())) {
        S.characters.push({ id: Date.now() + Math.random(), name, role: 'supporting', description: '', imageData: null, source: 'story' });
      }
    });

    // 2. Image prompt via Gemini
    updateLoadCard(loadCard, 'Crafting the sceneâ€¦', true);

    const charVisuals = S.characters.filter(c => c.description).map(c => `${c.name}: ${c.description}`).join('; ');
    const pRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ contents: [{ parts: [{ text: `Create a single detailed image generation prompt for this story scene. Capture the most cinematic moment. Include scene, lighting, mood, art style, colors. Output ONLY the prompt.\n\nGenre: ${S.genre}\n${charVisuals ? 'Characters: ' + charVisuals + '\n' : ''}Story:\n${text}` }] }] })
    });

    let imgPrompt = '';
    if (pRes.ok) {
      const pData = await pRes.json();
      imgPrompt = pData.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || '';
    }

    // 3. Image generation via generateContent endpoint
    updateLoadCard(loadCard, 'Painting the sceneâ€¦', true);

    let imageUrl = null;
    if (imgPrompt) {
      const iRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${imgModel}:generateContent?key=${geminiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: imgPrompt }] }],
          generationConfig: { responseModalities: ['IMAGE', 'TEXT'] }
        })
      });
      if (iRes.ok) {
        const iData = await iRes.json();
        // Walk parts looking for inlineData image
        const parts = iData.candidates?.[0]?.content?.parts || [];
        for (const part of parts) {
          if (part.inlineData?.mimeType?.startsWith('image/')) {
            imageUrl = `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
            break;
          }
        }
      } else {
        console.warn('Image generation failed:', await iRes.text());
      }
    }

    // Save history entry
    const entry = { id: Date.now(), text, imageUrl, genre: activeGenre, newChars };
    S.history.push(entry);
    saveStorage();

    // Replace load card
    loadCard.replaceWith(buildStoryCard(entry));

    if (newChars.length) toast(`âœ¨ New characters: ${newChars.join(', ')}`);

    document.getElementById('story-input').value = '';
    document.getElementById('story-input').style.height = 'auto';
    document.getElementById('story-empty').classList.add('hidden');

  } catch(err) {
    loadCard.remove();
    toast(err.message || 'Something went wrong', true);
    console.error(err);
  }

  btn.disabled = false; btn.classList.remove('loading'); btn.textContent = 'âœ¦';
}

function addLoadCard() {
  const el = document.createElement('div');
  el.className = 'story-card';
  el.innerHTML = `<div class="story-card-text"><div class="img-loading"><div class="spinner-ring"></div><span id="load-msg">Startingâ€¦</span></div></div>`;
  const feed = document.getElementById('story-feed');
  feed.insertBefore(el, feed.firstChild);
  document.getElementById('story-empty').classList.add('hidden');
  return el;
}

function updateLoadCard(el, msg) {
  const m = el.querySelector('#load-msg');
  if (m) m.textContent = msg;
}

function buildStoryCard(entry) {
  const el = document.createElement('div');
  el.className = 'story-card';

  const paras = entry.text.split(/\n\n+/).filter(Boolean).map(p => `<p>${p}</p>`).join('');

  el.innerHTML = `
    <div class="story-card-text">
      <div class="story-card-meta">
        <div class="genre-tag">${entry.genre}</div>
        <div class="meta-line"></div>
      </div>
      <div class="story-prose">${paras}</div>
    </div>
    <div class="story-card-image">
      ${entry.imageUrl
        ? `<img src="${entry.imageUrl}" alt="Story scene">`
        : `<div class="img-error">ğŸ¨ Image unavailable<br><small>Check Gemini key has Imagen access</small></div>`}
    </div>
    ${entry.newChars?.length ? `<div class="new-char-banner">âœ¦ New characters added: ${entry.newChars.join(', ')}</div>` : ''}
  `;
  return el;
}

// â”€â”€ CHARACTERS â”€â”€
function renderCharacters() {
  const list = document.getElementById('chars-list');
  list.innerHTML = '';

  if (!S.characters.length) {
    list.innerHTML = `<div class="chars-empty">No characters yet.<br>They'll be added automatically when<br>Grok introduces them in your story,<br>or tap + Add to create one.</div>`;
    return;
  }

  S.characters.forEach(c => {
    const el = document.createElement('div');
    el.className = 'char-card' + (c.role === 'protagonist' ? ' protagonist' : '');
    el.innerHTML = `
      <div class="char-top">
        <div class="char-img-wrap" onclick="triggerUpload(${c.id})">
          ${c.imageData
            ? `<img src="${c.imageData}" alt="${esc(c.name)}">`
            : `<div class="char-img-placeholder"><span>ğŸ–¼</span><span>Tap to add photo</span></div>`}
          <div class="char-img-overlay">ğŸ“·</div>
        </div>
        <div class="char-info">
          <input class="char-name-input" value="${esc(c.name)}" placeholder="Full name"
            oninput="updateChar(${c.id},'name',this.value)">
          <input class="char-nick-input" value="${esc(c.nickname||'')}" placeholder="Nickname / alias (optional)"
            oninput="updateChar(${c.id},'nickname',this.value)">
          <select class="char-role-select" onchange="updateChar(${c.id},'role',this.value)">
            <option value="supporting" ${c.role==='supporting'?'selected':''}>Supporting</option>
            <option value="protagonist" ${c.role==='protagonist'?'selected':''}>Protagonist</option>
            <option value="antagonist" ${c.role==='antagonist'?'selected':''}>Antagonist</option>
          </select>
        </div>
      </div>
      <div class="char-desc-wrap">
        <textarea class="char-desc-input"
          placeholder="Describe appearance, personality, traitsâ€¦"
          oninput="updateChar(${c.id},'description',this.value)">${esc(c.description||'')}</textarea>

```
  </div>
  <div class="char-footer-row">
    <span class="char-source-label">${c.source === 'story' ? 'â†³ from story' : 'â†³ manual'}</span>
    <button class="char-del-btn" onclick="deleteChar(${c.id})">Remove</button>
  </div>
`;
list.appendChild(el);
```

});
}

function addCharacter() {
S.characters.push({ id: Date.now(), name: â€˜New Characterâ€™, role: â€˜supportingâ€™, description: â€˜â€™, imageData: null, source: â€˜manualâ€™ });
saveStorage();
renderCharacters();
}

function updateChar(id, field, value) {
const c = S.characters.find(x => x.id === id);
if (c) { c[field] = value; saveStorage(); }
if (field === â€˜roleâ€™) renderCharacters();
}

function deleteChar(id) {
if (!confirm(â€˜Remove this character?â€™)) return;
S.characters = S.characters.filter(c => c.id !== id);
saveStorage();
renderCharacters();
}

function triggerUpload(id) {
uploadTargetId = id;
document.getElementById(â€˜char-uploadâ€™).click();
}

function handleCharUpload(e) {
const file = e.target.files[0];
if (!file || !uploadTargetId) return;
const reader = new FileReader();
reader.onload = ev => {
const c = S.characters.find(x => x.id === uploadTargetId);
if (c) { c.imageData = ev.target.result; saveStorage(); renderCharacters(); }
};
reader.readAsDataURL(file);
e.target.value = â€˜â€™;
}

// â”€â”€ HELPERS â”€â”€
function autoResize(el) {
el.style.height = â€˜autoâ€™;
el.style.height = Math.min(el.scrollHeight, 120) + â€˜pxâ€™;
}

function toast(msg, err = false) {
const t = document.getElementById(â€˜toastâ€™);
t.textContent = msg;
t.className = â€˜toast showâ€™ + (err ? â€™ errâ€™ : â€˜â€™);
setTimeout(() => t.classList.remove(â€˜showâ€™), 3500);
}

function esc(s) {
return String(s || â€˜â€™).replace(/&/g,â€™&â€™).replace(/</g,â€™<â€™).replace(/>/g,â€™>â€™).replace(/â€/g,â€™"â€™);
}

init();
</script>

</body>
</html>